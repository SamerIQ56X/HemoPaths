<!DOCTYPE html>
<html lang="ar" dir="rtl"> <!-- تم تغيير اللغة والاتجاه إلى العربية -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدير مسارات هيمو</title> <!-- تم تعريب العنوان -->
    <style>
        /* --- الأنماط الأساسية --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e, #0f0f23);
            min-height: 100vh; color: white; overflow: hidden;
            line-height: 1.6; font-size: 14px;
        }

        /* --- شريط التمرير المخصص --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f23; border-radius: 12px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 12px; border: 2px solid #0f0f23; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }
        html { scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.15) #0f0f23; }

        /* --- شريط العنوان المخصص القابل للسحب --- */
        .custom-title-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 32px; 
            background-color: #1c1e2b; 
            -webkit-app-region: drag; 
            z-index: 100000; display: flex; align-items: center;
            justify-content: space-between; padding: 0 10px 0 0; /* تعديل الحشوة لـ RTL */
            user-select: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .window-app-title { 
            color: #c5c6c7; 
            font-size: 0.8rem; 
            font-weight: 400; 
            -webkit-app-region: no-drag;
            padding-right: 5px; /* تعديل الحشوة لـ RTL */
            line-height: 32px; 
        }

        /* --- أزرار التحكم بالنافذة (نمط ويندوز) --- */
        .window-controls {
            position: static; -webkit-app-region: no-drag;
            display: flex; height: 100%; 
            margin-right: auto; /* تعديل الهامش لـ RTL */
            margin-left: 0;
        }
        /* html[dir="rtl"] .window-controls { margin-right: auto; margin-left: initial; } /* تم التعليق لأن الاتجاه محدد في html */
        
        .window-btn {
            width: 46px; 
            height: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            border: none;
            color: #c5c6c7; 
            cursor: pointer;
            transition: background-color 0.15s ease, color 0.15s ease; 
            -webkit-app-region: no-drag;
            padding: 0;
            border-radius: 0; 
        }
        .window-btn svg {
            width: 10px;
            height: 10px;
            fill: currentColor;
        }
        .window-btn:hover {
            background-color: rgba(255, 255, 255, 0.12); 
            color: white;
        }
        .close-btn:hover {
            background-color: #e81123; 
            color: white;
        }
        .minimize-btn:active, .close-btn:active {
             background-color: rgba(255, 255, 255, 0.2);
        }
        .close-btn:active {
            background-color: #f1707a; 
            color: white; 
        }


        /* --- الشريط الجانبي --- */
        .sidebar {
            position: fixed; right: 0; top: 32px; /* تعديل لـ RTL */
            width: 250px; height: calc(100vh - 32px); 
            background: rgba(10, 12, 28, 0.88); backdrop-filter: blur(18px); 
            border-left: 1px solid rgba(255, 255, 255, 0.08); /* تعديل لـ RTL */
            border-right: none;
            padding: 15px; transition: all 0.3s ease; z-index: 9999;
            display: flex; flex-direction: column;
        }
        .sidebar.collapsed { width: 70px; }
        html[dir="rtl"] .sidebar.collapsed .nav-text,
        html[dir="rtl"] .sidebar.collapsed .logo h2,
        html[dir="rtl"] .sidebar.collapsed .logo p { display: none; }
        html[dir="rtl"] .sidebar:not(.collapsed) .logo,
        html[dir="rtl"] .sidebar:not(.collapsed) .nav-text { opacity: 1; transition: opacity 0.2s 0.1s ease-in-out; }
        html[dir="rtl"] .sidebar.collapsed .logo,
        html[dir="rtl"] .sidebar.collapsed .nav-text { opacity: 0; pointer-events: none; }

        .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; padding-top: 10px; }
        .logo { opacity: 1; transition: opacity 0.3s ease; }
        .sidebar.collapsed .logo { opacity: 0; pointer-events: none; }
        .logo h2 {
            font-size: 20px; background: linear-gradient(45deg, #4fc3f7, #29b6f6, #03a9f4, #0288d1);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-fill-color: transparent; white-space: nowrap;
        }
        .logo p { color: #64b5f6; font-size: 10px; margin-top: -4px; white-space: nowrap; }
        .menu-toggle {
            background: none; border: none; color: #90a4ae; cursor: pointer; padding: 8px;
            border-radius: 8px; transition: all 0.3s ease; display: flex;
            align-items: center; justify-content: center; -webkit-app-region: no-drag;
        }
        .menu-toggle:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .sidebar.collapsed .menu-toggle { margin-left: auto; margin-right: auto; }
        .nav-menu { list-style: none; padding: 0; }
        .nav-item { margin-bottom: 6px; }
        .nav-link {
            display: flex; align-items: center; padding: 10px 15px; color: #90a4ae;
            text-decoration: none; border-radius: 8px; transition: all 0.2s ease;
            cursor: pointer; white-space: nowrap;
        }
        .nav-link:hover, .nav-link.active:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .nav-link.active {
            background: linear-gradient(90deg, #1e3a8a, #3b82f6, #6366f1); color: white;
            box-shadow: 0 3px 12px rgba(59, 130, 246, 0.2);
        }
        .nav-icon { margin-left: 12px; margin-right:0; width: 18px; height: 18px; flex-shrink: 0; } /* تعديل لـ RTL */
        .sidebar.collapsed .nav-link { justify-content: center; }
        .sidebar.collapsed .nav-icon { margin-left: 0; } /* تعديل لـ RTL */

        /* --- منطقة المحتوى الرئيسية --- */
        .main-content {
            margin-right: 250px; margin-left:0; padding: 20px; /* تعديل لـ RTL */
            padding-top: calc(20px + 32px); transition: margin-right 0.3s ease; min-height: 100vh; /* تعديل لـ RTL */
            overflow-y: auto; height: calc(100vh - 32px);
        }
        .main-content.expanded { margin-right: 70px; margin-left:0; } /* تعديل لـ RTL */
        .page { display: none; animation: fadeInContent 0.4s ease-out; }
        .page.active { display: block; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
         
        .page-header-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px;
        }
        .page-header-container .page-title {
            font-size: 1.8rem; font-weight: 700;
            background: linear-gradient(45deg, #ffffff, #e3f2fd, #bbdefb);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-fill-color: transparent; margin-bottom: 4px;
        }
        .page-header-container .page-subtitle { color: #64b5f6; font-size: 0.9rem; }

        .container { /* لمحتوى مدير المسارات */
            max-width: 100%; margin: 0 auto; background: rgba(10, 10, 30, 0.45); 
            backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px; box-shadow: 0 6px 25px 0 rgba(0, 0, 0, 0.3); overflow: hidden;
        }
        .header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .header h1 {
            font-size: 2rem; font-weight: 700;
            background: linear-gradient(45deg, #ffffff, #e3f2fd, #bbdefb);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-fill-color: transparent;
            margin-bottom: 6px; text-transform: capitalize;
        }
        .header p { color: #64b5f6; font-size: 0.9rem; }
        .top-actions-bar {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 18px;
            background: rgba(15, 15, 35, 0.35); border-bottom: 1px solid rgba(255, 255, 255, 0.07);
            flex-wrap: wrap; gap: 10px;
        }
        .stats { font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; color: #90a4ae; }
        .stats svg { margin-left: 8px; margin-right:0; width: 16px; height: 16px; vertical-align: middle; fill: #64b5f6; } /* تعديل لـ RTL */

        .btn {
            padding: 9px 18px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; transition: all 0.25s ease; text-decoration: none; display: inline-flex;
            align-items: center; gap: 7px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); text-transform: none;
        }
        .btn svg { width: 15px; height: 15px; fill: currentColor; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25); }
        .btn:active { transform: translateY(0px); box-shadow: 0 1px 4px rgba(0,0,0,0.15); }
        .btn:disabled {
            background: rgba(120, 120, 120, 0.15) !important; border-color: rgba(120, 120, 120, 0.15) !important;
            color: #6c7a86 !important; cursor: not-allowed; opacity: 0.5;
            transform: translateY(0); box-shadow: none;
        }
        .btn-primary {
            background: linear-gradient(45deg, #1565c0, #1976d2, #1e88e5, #2196f3); color: white;
            box-shadow: 0 3px 12px rgba(33, 150, 243, 0.25); padding: 10px 22px; border-radius: 10px;
        }
        .btn-primary:hover { box-shadow: 0 5px 18px rgba(33, 150, 243, 0.35); }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.08); color: #90a4ae; border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.12); color: white; }
        .btn-danger {
            background: linear-gradient(45deg, #d32f2f, #e53935, #f44336); color: white;
            box-shadow: 0 3px 12px rgba(244, 67, 54, 0.25);
        }
        .btn-danger:hover { background: linear-gradient(45deg, #c62828, #d32f2f, #e53935); box-shadow: 0 5px 18px rgba(244, 67, 54, 0.35); }
        .btn-success {
            background: linear-gradient(45deg, #2e7d32, #388e3c, #43a047, #4caf50); color: white;
            box-shadow: 0 3px 12px rgba(76, 175, 80, 0.25);
        }
        .btn-success:hover { background: linear-gradient(45deg, #1b5e20, #2e7d32, #388e3c); box-shadow: 0 5px 18px rgba(76, 175, 80, 0.35); }
        .btn-icon {
            background: transparent; border: none; color: #90a4ae; padding: 7px; line-height: 1;
            border-radius: 6px; transition: all 0.2s ease;
        }
        .btn-icon:hover { color: white; background-color: rgba(255, 255, 255, 0.08); }
        .btn-icon svg { width: 16px; height: 16px; }
        .btn-icon:disabled { color: #5f6770 !important; background-color: transparent !important; cursor: not-allowed;}
        .btn-icon:disabled svg { fill: #5f6770 !important; }

        /* تم إزالة زر الإضافة العائم */
        /* .add-item-fab { ... } */

        /* قسم إضافة العناصر المدمج (سابقًا كان مودال) */
        .integrated-add-item-section {
            padding: 20px;
            background: rgba(15, 15, 35, 0.6); /* خلفية أغمق قليلاً للتمييز */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            border-radius: 0 0 12px 12px; /* تدوير الزوايا السفلية إذا كان تحت الهيدر مباشرة */
        }
        .integrated-add-item-section h2 { /* يمكن إزالة هذا إذا لم يعد هناك عنوان رئيسي للقسم */
            text-align: center; font-size: 1.5rem; font-weight: 600; margin-bottom: 18px;
            color: #b0bec5;
        }
        .integrated-add-item-section .input-group { display: flex; flex-direction: column; gap: 15px; } 
        .integrated-add-item-section .input-row { display: flex; gap: 12px; flex-wrap: wrap; }
        .integrated-add-item-section .add-item-actions { /* لتوسيط زر الإضافة الرئيسي */
            text-align: center; margin-top:15px;
        }


        #selectedFilesDisplay { margin-top: 10px; font-size: 0.75rem; color: #90a4ae; max-height: 50px; overflow-y: auto;} /* اسم جديد لعرض الملفات المختارة */
        #itemsDisplayArea { padding: 18px; }

        .category-section {
            margin-bottom: 20px; background: rgba(5, 5, 20, 0.45); 
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 10px; box-shadow: 0 3px 18px rgba(0,0,0,0.2); transition: all 0.25s ease;
        }
        .category-section:hover { background: rgba(10, 10, 25, 0.55); border-color: rgba(255, 255, 255, 0.1); }
        .category-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.07);
            cursor: pointer; user-select: none; background-color: rgba(20, 20, 40, 0.45); 
            border-top-left-radius: 10px; border-top-right-radius: 10px; transition: background-color 0.25s ease;
        }
        .category-header:hover { background-color: rgba(25, 25, 45, 0.55); }
        .category-header:hover .category-title { color: #64b5f6; } 
        .category-title-container { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .category-toggle-icon svg { width: 11px; height: 11px; fill: #90a4ae; transition: transform 0.25s ease-in-out; }
        html[dir="rtl"] .category-section:not(.collapsed) .category-toggle-icon svg { transform: rotate(-90deg); } /* تعديل لـ RTL */
        html[dir="ltr"] .category-section:not(.collapsed) .category-toggle-icon svg { transform: rotate(90deg); }

        .category-title { font-size: 1.1rem; font-weight: 600; color: white; text-transform: capitalize; margin-left: 5px; } /* هامش لـ RTL */
        .category-name-input { /* حقل إدخال لتعديل اسم القسم */
            font-size: 1.1rem; font-weight: 600; color: white;
            background-color: rgba(255,255,255,0.1); border: 1px solid #64b5f6;
            border-radius: 5px; padding: 3px 8px; flex-grow:1; margin-left: 5px;
        }

        .category-item-count {
            background: rgba(255, 255, 255, 0.08); color: #64b5f6; padding: 2px 9px;
            border-radius: 18px; font-size: 0.7rem; margin-right: 8px; /* تعديل لـ RTL */
        }
         
        .category-header-controls { display: flex; align-items: center; gap: 5px; } /* حاوية جديدة لأزرار التحكم بالقسم */
        .category-header-controls .btn-icon { padding: 5px; }
        .category-header-controls .btn-icon svg { width: 14px; height: 14px; }
        .category-header-controls .btn-open-all-in-category { padding: 5px 10px; font-size: 0.7rem; }
        .category-header-controls .btn-open-all-in-category svg { width: 12px; height: 12px;}
        .category-on-off-toggle { /* زر التشغيل/الإيقاف */
            padding: 4px 8px; font-size: 0.7rem; border-radius: 5px;
            cursor: pointer; transition: background-color 0.2s, color 0.2s;
        }
        .category-on-off-toggle.on { background-color: #4caf50; color: white; }
        .category-on-off-toggle.off { background-color: #555; color: #ccc; }


        .items-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); 
            gap: 18px; padding: 18px; max-height: 1200px; overflow-y: auto; opacity: 1;
            transition: max-height 0.25s ease-out, opacity 0.25s ease-out, padding 0.25s ease-out;
        }
        .category-section.collapsed .items-grid { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top:0; overflow: hidden; }
        .category-section.collapsed .category-header { border-bottom-color: transparent; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; }

        .item-card {
            background: rgba(5, 5, 20, 0.65); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.07); border-radius: 10px; 
            padding: 16px; box-shadow: 0 3px 12px rgba(0,0,0,0.18);
            transition: all 0.25s ease; display: flex; flex-direction: column;
            justify-content: space-between; position: relative; min-height: 130px; 
        }
        .item-card:hover {
            background: rgba(10, 10, 25, 0.75); border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px); box-shadow: 0 5px 18px rgba(0,0,0,0.28);
        }
        .item-card-main { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .item-card-icon svg { width: 28px; height: 28px; fill: #64b5f6; flex-shrink: 0; }
        .item-card-info { overflow: hidden; flex-grow: 1; }
        .item-card-name { font-size: 0.95rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; }
        .item-card-filetype { font-size: 0.75rem; color: #90a4ae; } 
        .item-card-path {
            font-size: 0.7rem; color: #64b5f6; margin: 6px 0; word-break: break-all;
            max-height: 2.8em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .item-card-footer {
            margin-top: auto; display: flex; justify-content: space-between; align-items: center;
            padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.07);
        }
        .item-card-date { font-size: 0.65rem; color: #78828c; }
        .item-card-actions-trigger { -webkit-app-region: no-drag; }
        .item-card-actions-trigger svg { width: 16px; height: 16px; }
        .item-card-direct-open { -webkit-app-region: no-drag; margin-right: 8px; margin-left:0; flex-shrink: 0; } /* تعديل لـ RTL */


        .item-actions-menu {
            display: none; position: absolute; background-color: rgba(20, 20, 40, 0.88); 
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.35);
            z-index: 500; min-width: 190px; overflow: hidden; padding: 6px; 
        }
        .item-actions-menu.show { display: block; animation: fadeIn 0.15s ease-out; }
        html[dir="rtl"] .item-actions-menu { right: 8px; left:auto; } 
        html[dir="ltr"] .item-actions-menu { left: 8px; right:auto; } 
        .item-actions-menu button {
            display: flex; align-items: center; gap: 8px; width: 100%; padding: 9px 12px;
            background: none; border: none; cursor: pointer; font-size: 0.8rem;
            color: #b0bec5; transition: all 0.15s ease; text-align: right; /* تعديل لـ RTL */
            border-radius: 6px; margin: 0; 
        }
        /* html[dir="rtl"] .item-actions-menu button { text-align: right; } */
        .item-actions-menu button svg { width: 14px; height: 14px; fill: currentColor; margin-left: 8px; margin-right:0; } /* تعديل لـ RTL */
        /* html[dir="rtl"] .item-actions-menu button svg { margin-left: 8px; margin-right: 0; } */
        .item-actions-menu button:hover { background-color: rgba(33, 150, 243, 0.18); color: #64b5f6; }
        .item-actions-menu button:hover svg { fill: #64b5f6; }
        .item-actions-menu button[data-action="delete"]:hover { background-color: rgba(244, 67, 54, 0.18); color: #f44336; }
        .item-actions-menu button[data-action="delete"]:hover svg { fill: #f44336; }

        .empty-placeholder { text-align: center; padding: 35px 18px; color: #90a4ae; }
        .empty-placeholder .icon svg { width: 45px; height: 45px; fill: rgba(255,255,255,0.18); margin-bottom: 12px; }
        .empty-placeholder h3 { font-size: 1.3rem; margin-bottom: 7px; color: white;}
        .empty-placeholder p { font-size: 0.95rem; }

        /* أنماط إشعار التوست في الأسفل والوسط */
        .notification-toast {
            position: fixed;
            bottom: 60px; /* مسافة أعلى شريط التقدم */
            left: 50%;
            transform: translateX(-50%) translateY(20px); /* يبدأ من الأسفل قليلاً */
            background-color: rgba(20, 20, 40, 0.92);
            backdrop-filter: blur(12px);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.35);
            z-index: 100002; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0s 0.25s linear;
            max-width: 380px;
            font-size: 0.88rem;
            border-top: 3px solid transparent; /* تم تغيير الاتجاه إلى الأعلى */
        }
        .notification-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            transition-delay: 0s;
        }
        .notification-toast.success { border-top-color: #4caf50; } 
        .notification-toast.error { border-top-color: #f44336; } 
        .notification-toast.warning { border-top-color: #ffc107; } 
        .notification-toast.info { border-top-color: #2196f3; } 
         
        .loading-indicator, .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.65); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            z-index: 99998; opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease-out, visibility 0s 0.25s linear;
        }
        #confirmModalBackdrop, #addItemModal { z-index: 100001; } 
        .loading-indicator.show, .modal-backdrop.show { opacity: 1; visibility: visible; transition-delay: 0s; }
        .spinner {
            width: 32px; height: 32px; border: 3.5px solid rgba(255, 255, 255, 0.18); 
            border-top-color: #2196f3; border-radius: 50%; animation: spin 0.65s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-dialog { 
            background: rgba(10, 10, 30, 0.88); backdrop-filter: blur(18px);
            padding: 22px 28px; border-radius: 14px; box-shadow: 0 7px 30px rgba(0,0,0,0.38);
            text-align: center; max-width: 380px; 
            transform: scale(0.96) translateY(8px);
            transition: transform 0.25s ease-out, opacity 0.25s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.12); opacity: 0;
        }
        .modal-backdrop.show .modal-dialog { transform: scale(1) translateY(0); opacity: 1; }
        .modal-dialog p { margin-bottom: 18px; font-size: 0.95rem; color: white; }
        .modal-dialog-actions { display: flex; justify-content: center; gap: 12px; }
        .modal-dialog-actions button { min-width: 90px; }

        #categoryManagerModal { z-index: 100000; } 
        .category-manager-content {
            background: rgba(15, 15, 35, 0.92); backdrop-filter: blur(22px);
            padding: 22px; border-radius: 14px; width: 90%; max-width: 580px; 
            border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: 0 8px 35px rgba(0,0,0,0.45);
            transform: scale(0.96) translateY(8px);
            transition: transform 0.25s ease-out, opacity 0.25s ease-out; opacity: 0;
        }
        .modal-backdrop.show .category-manager-content { transform: scale(1) translateY(0); opacity: 1; }
        .category-manager-content h2 {
            text-align: center; font-size: 1.7rem; font-weight: 700; margin-bottom: 22px;
            background: linear-gradient(45deg, #4fc3f7, #29b6f6, #03a9f4); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-fill-color: transparent;
        }
        #categoryListContainer {
            max-height: 330px; overflow-y: auto; margin-bottom: 22px;
            border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 10px;
            padding: 8px; background-color: rgba(5, 5, 20, 0.45); 
        }
        .category-manager-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; border-bottom: 1px solid rgba(255, 255, 255, 0.07);
            font-size: 0.9rem; color: white; transition: background-color 0.15s ease;
            border-radius: 7px; margin-bottom: 4px; 
        }
        .category-manager-item:hover { background-color: rgba(255,255,255,0.06); }
        .category-manager-item:last-child { border-bottom: none; margin-bottom: 0; }
        .category-manager-item-name-container { flex-grow: 1; display: flex; align-items: center; min-width: 0; gap: 8px; }
        .category-manager-item-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 2px 0; }
        .category-name-input-inline { font-size: 0.9rem; padding: 7px 10px; margin: 0; height: auto; line-height: 1.4; width: 100%; }
        .category-manager-item-controls { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .category-manager-item .btn-icon { margin-left: 0; margin-right: 0; padding: 7px; }
        .category-manager-item .btn-icon.btn-edit-managed-category { color: #64b5f6; } 
        .category-manager-item .btn-icon.btn-edit-managed-category:hover { background-color: rgba(33, 150, 243, 0.12); }
        .category-manager-item .btn-icon.btn-delete-managed-category { color: #f44336; } 
        .category-manager-item .btn-icon.btn-delete-managed-category:hover { background-color: rgba(244, 67, 54, 0.12); }
        .category-manager-item .btn-icon.btn-save-inline-edit { color: #4caf50; } 
        .category-manager-item .btn-icon.btn-save-inline-edit:hover { background-color: rgba(76, 175, 80, 0.12); }
        .category-manager-item .btn-icon.btn-cancel-inline-edit { color: #90a4ae; }
        .category-manager-item .btn-icon.btn-cancel-inline-edit:hover { background-color: rgba(144, 164, 174, 0.12); }
        .category-manager-item .btn-icon svg { width: 15px; height: 15px; }
        .category-tag {
            font-size: 0.65rem; padding: 3px 9px; border-radius: 18px; 
            color: white; background-color: rgba(255, 255, 255, 0.08);
            font-weight: 500; flex-shrink: 0;
        }
        .category-tag.custom { background-color: rgba(33, 150, 243, 0.25); color: #e3f2fd; } 
        .add-category-form { display: flex; gap: 12px; margin-top: 18px; padding-top: 18px; border-top: 1px solid rgba(255, 255, 255, 0.08); }
        #newManagedCategoryInput { margin-bottom: 0; width: 100%; }
        #addManagedCategoryBtn { flex-shrink: 0; }
        .category-manager-actions { text-align: center; margin-top:25px;}

        /* --- أنماط خاصة بقائمة المهام --- */
        .todo-input-container { display: flex; gap: 10px; margin-bottom: 18px; }
        .todo-input { flex: 1; }
        #todosContainer { display: flex; flex-direction: column; gap: 8px; }
        .todo-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 7px;
            transition: all 0.25s ease;
        }
        .todo-item:hover { background: rgba(255, 255, 255, 0.08); }
        .todo-item.completed { background: rgba(76, 175, 80, 0.08); border-right-color: #4caf50; border-left: 1px solid rgba(255,255,255,0.08); } /* تعديل لـ RTL */
        /* html[dir="rtl"] .todo-item.completed { border-right-color: #4caf50; border-left-color: rgba(255,255,255,0.08); } */
        .todo-item-left { display: flex; align-items: center; gap: 8px; flex-grow: 1; }
        .todo-checkbox {
            width: 18px; height: 18px; border: 1.5px solid #64b5f6; border-radius: 5px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.25s ease; flex-shrink: 0;
        }
        .todo-checkbox svg { width: 11px; height: 11px; fill: white; opacity: 0; transition: opacity 0.15s; }
        .todo-item.completed .todo-checkbox { background: #4caf50; border-color: #4caf50; }
        .todo-item.completed .todo-checkbox svg { opacity: 1; }
        .todo-text { color: white; transition: all 0.25s ease; word-break: break-word; font-size: 0.9rem; }
        .todo-item.completed .todo-text { text-decoration: line-through; opacity: 0.65; }
        .todo-text-edit-input { 
            flex-grow: 1; background: rgba(35, 38, 60, 0.85); color: #e8eaf6; border: 1px solid #42a5f5;
            border-radius: 4px; padding: 4px 8px; font-size: 0.9rem;
        }

        .todo-date { font-size: 0.7rem; color: #90a4ae; margin-right: auto; padding-right: 8px; flex-shrink: 0;} /* تعديل لـ RTL */
        /* html[dir="rtl"] .todo-date { margin-right: auto; padding-right: 8px; margin-left:0; padding-left:0;} */
        .todo-item-actions { display:flex; gap: 6px; } 
        .todo-item .btn-icon { padding: 5px; } 
        .todo-item .btn-icon svg { width: 13px; height: 13px; }

        /* أنماط خاصة بصفحة الخيارات */
        #optionsPage .glass-card { padding: 25px; }
        #optionsPage .options-group {
            margin-bottom: 30px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
        }
        #optionsPage .options-group:last-child { border-bottom: none; margin-bottom: 0; }
        #optionsPage .options-group h3 {
            font-size: 1.3rem; 
            color: #81c784; 
            margin-bottom: 12px;
            padding-bottom: 8px;
        }
        #optionsPage .options-group p {
            font-size: 0.85rem;
            color: #b0bec5; 
            margin-bottom: 15px; 
            line-height: 1.5;
        }
        #optionsPage .options-group .btn { margin-top: 8px;} 
        #optionsPage .input-row { margin-bottom: 12px;} 
        #optionsPage .input-row label { font-size: 0.85rem; color: #b0bec5; margin-left: 10px; margin-right:0; min-width: 120px; } /* تعديل لـ RTL */


        #extensionMappingsContainer { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; max-height: 220px; overflow-y: auto; padding:10px; background: rgba(0,0,0,0.1); border-radius: 6px;}
        .extension-mapping-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; background: rgba(255,255,255,0.03); border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.07);
        }
        .extension-mapping-item span { font-size: 0.9rem; }
        .extension-mapping-item .btn-icon { padding: 4px; background-color: transparent;}
        .extension-mapping-item .btn-icon:hover { background-color: rgba(255,82,82,0.1);}
        .extension-mapping-item .btn-icon svg { width: 12px; height: 12px; fill: #ff8a80; }
        .extension-mapping-item .btn-icon:hover svg { fill: #ff5252; }

        /* صفحة عمليات الملفات: قائمة السجل */
        #projectHistoryContainer .extension-mapping-item { 
            cursor: pointer;
        }
        #projectHistoryContainer .extension-mapping-item:hover {
            background-color: rgba(255, 255, 255, 0.06);
        }
        #projectHistoryContainer .empty-history-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #90a4ae;
            font-size: 0.9rem;
        }
        #projectHistoryContainer .empty-history-message svg {
            width: 32px;
            height: 32px;
            fill: rgba(255,255,255,0.2);
            margin-bottom: 10px;
        }


        /* توسيط صفحة "حول" */
        #aboutPage .glass-card {
            max-width: 700px; 
            margin-left: auto;
            margin-right: auto;
            padding: 30px;
            text-align: center; 
        }
        #aboutPage h3 {
            font-size: 1.6rem; color: #64b5f6; margin-bottom: 15px;
        }
        #aboutPage p {
            font-size: 1rem; color: #c5cae9; margin-bottom: 10px; line-height: 1.7;
        }
        #aboutPage h4 {
            font-size: 1.1rem; color: #81c784; margin-top: 20px; margin-bottom: 10px;
        }
        #aboutPage ul { list-style-position: inside; padding-right: 0; padding-left:initial; text-align: right; max-width: 400px; margin: 0 auto;} /* تعديل لـ RTL */
        #aboutPage li { margin-bottom: 8px; color: #b0bec5;}

        /* أنماط شريط تقدم التحميل */
        .download-progress-bar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 25px; 
            background-color: rgba(10, 10, 30, 0.85); 
            backdrop-filter: blur(6px);
            z-index: 100001; 
            display: none; 
            padding: 3px; 
            box-sizing: border-box;
            border-top: 1px solid rgba(255,255,255,0.1); 
        }
        .download-progress-bar-inner {
            width: 0%; 
            height: 100%;
            background: linear-gradient(90deg, #1e3a8a, #3b82f6); 
            border-radius: 3px; 
            transition: width 0.15s ease-out; 
            display: flex;
            align-items: center;
            justify-content: center; 
            overflow: hidden; 
        }
        .download-progress-bar-text {
            color: white;
            font-size: 0.75rem; 
            font-weight: 500;
            text-shadow: 0 0 3px rgba(0,0,0,0.5); 
            white-space: nowrap; 
            padding: 0 8px; 
        }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .fade-in-item { animation: fadeIn 0.25s ease-out forwards; animation-delay: calc(var(--card-index, 0) * 0.04s); opacity: 0; }

        @media (max-width: 768px) {
            body { padding: 0; font-size:13px; }
            .main-content { margin-right: 0; margin-left:0; padding:10px; padding-top: calc(10px + 32px); } /* تعديل لـ RTL */
            .main-content.expanded { margin-right: 0; margin-left:0; } 
            .sidebar { transform: translateX(100%); box-shadow: -3px 0 12px rgba(0,0,0,0.15); top: 32px; height: calc(100vh - 32px);} /* تعديل لـ RTL */
            /* html[dir="rtl"] .sidebar { transform: translateX(100%); box-shadow: -3px 0 12px rgba(0,0,0,0.15); } */
            .sidebar.show { transform: translateX(0); }
            .container { margin: 8px; width:auto; }
            .header { padding: 18px 12px; } .header h1 { font-size: 1.7rem; }
            .top-actions-bar, .integrated-add-item-section .input-row { padding: 12px; } /* تعديل ليشمل القسم المدمج */
            .top-actions-bar { flex-direction: column; align-items: stretch; }
            .top-actions-bar .btn { width: 100%; margin-bottom: 8px; }
            .input-row { flex-direction: column; gap: 12px; }
            .items-grid { grid-template-columns: 1fr; gap: 12px;} 
            .item-card { min-height: auto; padding: 12px; } 
            .notification-toast {
                max-width: calc(100% - 36px); 
                left: 50%;
                bottom: 10px; 
                transform: translateX(-50%);
            }
            .category-manager-content, .add-item-modal-content { max-width: 96%; padding: 18px;}
            .modal-dialog { max-width: 92%; padding: 18px; }
            #optionsPage .options-group { padding-bottom: 15px; margin-bottom: 20px; }
            .download-progress-bar-container { height: 20px; } 
            .download-progress-bar-text { font-size: 0.7rem; }
        }
        @media (max-width: 480px) {
            .custom-title-bar { height: 30px; padding: 0 8px 0 6px; } 
            .sidebar { top: 30px; height: calc(100vh - 30px); }
            .main-content { padding-top: calc(10px + 30px); height: calc(100vh - 30px); }
            .header h1 { font-size: 1.5rem; } .header p { font-size: 0.8rem; }
            .btn { font-size: 0.8rem; padding: 8px 14px; } .btn-primary { padding: 9px 18px; }
            .category-title { font-size: 1rem; }
            .category-item-count { font-size: 0.65rem; padding: 2px 7px;}
            .category-header-controls .btn-open-all-in-category { font-size: 0.7rem; padding: 5px 9px;}
            .category-manager-content h2 { font-size: 1.4rem; }
            .sidebar.collapsed { width: 55px; } 
            .main-content.expanded { margin-right: 55px; margin-left:0;} /* تعديل لـ RTL */
            /* html[dir="rtl"] .main-content.expanded { margin-right: 55px; } */
            #optionsPage .options-group h3 { font-size: 1.1rem; }
        }

    </style>
</head>
<body>
    <!-- ... (محتوى body و script سيبقى كما هو في الرد السابق مع تعديلات طفيفة) ... -->
    <!-- شريط العنوان المخصص -->
    <div class="custom-title-bar">
        <span class="window-app-title">مدير مسارات هيمو</span>
        <div class="window-controls">
            <button class="window-btn minimize-btn" onclick="handleMinimizeWindow()" title="تصغير">
                <svg viewBox="0 0 10 10"><path d="M0 4h10v2H0z"/></svg>
            </button>
            <button class="window-btn close-btn" onclick="handleCloseWindow()" title="إغلاق">
                <svg viewBox="0 0 10 10"><path d="M0 0l10 10M10 0l-10 10" stroke="currentColor" stroke-width="1.5" /></svg>
            </button>
        </div>
    </div>

    <!-- الشريط الجانبي -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <h2>مسارات هيمو</h2>
                <p>المدير</p>
            </div>
            <button class="menu-toggle" onclick="toggleSidebar()" title="تبديل القائمة">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active" onclick="showPage('pathsPage')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><use xlink:href="#icon-folder"></use></svg>
                    <span class="nav-text">مدير المسارات</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showPage('todosPage')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><use xlink:href="#icon-check"></use></svg> <span class="nav-text">قائمة المهام</span>
                </a>
            </li>
             <li class="nav-item"> 
                <a href="#" class="nav-link" onclick="showPage('fileOperationsPage')">
                     <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><use xlink:href="#icon-save"></use></svg> <span class="nav-text">ملف</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showPage('optionsPage')"> 
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"> <use xlink:href="#icon-settings-alt"></use></svg> <span class="nav-text">الخيارات</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showPage('aboutPage')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"> <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/> </svg>
                    <span class="nav-text">حول</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- المحتوى الرئيسي -->
    <main class="main-content" id="mainContent">
        <!-- تم إزالة الزر العائم -->
        <!-- <button class="add-item-fab" id="addItemFab" title="Add New Item">
            <svg viewBox="0 0 24 24"><use xlink:href="#icon-add"></use></svg>
        </button> -->

        <div id="pathsPage" class="page active">
            <!-- قسم إضافة العناصر المدمج -->
            <div class="integrated-add-item-section">
                <h2>إضافة عنصر جديد</h2> <!-- يمكن تعديل هذا العنوان أو إزالته -->
                <div class="input-group">
                    <div class="input-row">
                        <button id="integratedSelectFilesButton" class="btn btn-secondary">
                            <svg viewBox="0 0 24 24"><use xlink:href="#icon-add"></use></svg>إضافة ملفات
                        </button>
                        <button id="integratedAddFolderLinkButton" class="btn btn-secondary">
                            <svg viewBox="0 0 24 24"><use xlink:href="#icon-folder"></use></svg>إضافة رابط مجلد
                        </button>
                        <button id="integratedImportFromFolderButton" class="btn btn-secondary">
                            <svg viewBox="0 0 24 24"><use xlink:href="#icon-folder"></use></svg>استيراد من مجلد
                        </button>
                    </div>
                    <div class="input-row paste-path-group">
                        <input type="text" id="integratedPathInput" class="input-field" placeholder="أو الصق مسار ملف/مجلد/موقع هنا">
                        <button id="integratedPastePathButton" class="btn btn-secondary" style="flex-shrink: 0;">
                            <svg viewBox="0 0 24 24"><use xlink:href="#icon-paste"></use></svg>لصق
                        </button>
                        <button id="integratedAddPastedPathButton" class="btn btn-primary" style="flex-shrink: 0;">
                            <svg viewBox="0 0 24 24"><use xlink:href="#icon-add"></use></svg>إضافة مسار
                        </button>
                    </div>
                    <div class="input-row">
                        <input type="text" id="integratedProjectNameInput" class="input-field" placeholder="اسم وصفي للعنصر (اختياري)">
                        <select id="integratedCategorySelectInput" class="input-field"></select>
                    </div>
                    <div id="integratedSelectedFilesDisplay"></div> <!-- لعرض الملفات المختارة هنا -->
                </div>
                <div class="add-item-actions"> <!-- تم تغيير الاسم ليكون أكثر تحديدًا -->
                    <button id="integratedAddItemsButton" class="btn btn-success">
                        <svg viewBox="0 0 24 24"><use xlink:href="#icon-add"></use></svg>إضافة إلى القائمة
                    </button>
                </div>
            </div>

            <div class="container">
                <div class="header">
                    <h1>مدير ملفات المشروع</h1> <p>نظم وأدر ملفات مشروعك بكفاءة</p> </div>

                <div class="top-actions-bar">
                    <div class="stats">
                        <svg viewBox="0 0 24 24"><use xlink:href="#icon-folder"></use></svg>
                        إجمالي العناصر: <span id="fileCount">0</span> </div>
                    <div>
                        <button id="openAllBtn" class="btn btn-primary">
                            <svg viewBox="0 0 24 24"><use xlink:href="#icon-rocket"></use></svg>
                            فتح الكل </button>
                        </div>
                </div>
                <div id="itemsDisplayArea"></div>
            </div>
        </div>

        <div id="todosPage" class="page">
            <div class="page-header-container">
                <div>
                    <h1 class="page-title">قائمة المهام</h1>
                    <p class="page-subtitle">تتبع مهامك ومشاريعك</p>
                </div>
            </div>
            <div class="glass-card">
                <div class="todo-input-container">
                    <input type="text" id="todoInput" class="input-field todo-input" placeholder="أضف مهمة جديدة...">
                    <button id="addTodoBtn" class="btn btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-left: 8px; margin-right:0;"> <!-- تعديل لـ RTL -->
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        إضافة مهمة
                    </button>
                </div>
                <div id="todosContainer"></div>
            </div>
        </div>
        
        <div id="fileOperationsPage" class="page">
            <div class="page-header-container">
                <div>
                    <h1 class="page-title">عمليات الملفات</h1>
                    <p class="page-subtitle">إدارة ملفات بيانات مشروعك</p>
                </div>
            </div>
            <div class="glass-card">
                <div class="options-group">
                    <h3>ملف المشروع</h3>
                    <p>احفظ جميع المسارات والفئات والمهام الحالية في ملف، أو قم بتحميلها من ملف محفوظ مسبقًا.</p>
                    <div style="display: flex; gap: 10px; margin-top:10px; flex-wrap:wrap;">
                        <button id="saveProjectAsBtn" class="btn btn-primary">
                            <svg viewBox="0 0 24 24"><use xlink:href="#icon-save"></use></svg> حفظ المشروع باسم...
                        </button>
                        <button id="importProjectBtn" class="btn btn-secondary">
                            <svg viewBox="0 0 24 24"><use xlink:href="#icon-open"></use></svg> استيراد مشروع...
                        </button>
                         <button id="saveActiveProjectBtn" class="btn btn-success" disabled> <svg viewBox="0 0 24 24"><use xlink:href="#icon-save"></use></svg> حفظ المشروع الحالي
                        </button>
                    </div>
                     <p id="activeProjectInfo" style="font-size: 0.8rem; color: #90a4ae; margin-top: 10px;">لا يوجد ملف مشروع نشط.</p>
                </div>
                <div class="options-group">
                    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 5px;">
                        <h3>السجل</h3>
                        <button id="clearHistoryBtn" class="btn btn-danger btn-icon" title="مسح السجل">
                             <svg viewBox="0 0 24 24"><use xlink:href="#icon-clear-all"></use></svg>
                        </button>
                    </div>
                    <p>ملفات المشاريع المفتوحة أو المحفوظة مؤخرًا.</p>
                    <div id="projectHistoryContainer" style="max-height: 200px; overflow-y: auto; padding: 5px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                        </div>
                </div>
            </div>
        </div>


        <div id="optionsPage" class="page">
            <div class="page-header-container">
                <div>
                    <h1 class="page-title">الخيارات</h1>
                    <p class="page-subtitle">تكوين إعدادات وتفضيلات التطبيق</p>
                </div>
            </div>
            <div class="glass-card">
                <div class="options-group">
                    <h3>إدارة الفئات</h3>
                    <p>نظم كيفية تجميع العناصر الخاصة بك.</p>
                    <button id="manageCategoriesBtn" class="btn btn-secondary">
                        <svg viewBox="0 0 24 24"><use xlink:href="#icon-settings-alt"></use></svg> إدارة الفئات
                    </button>
                </div>

                <div class="options-group">
                    <h3>ربط امتدادات الملفات</h3>
                    <p>قم بتعيين فئات تلقائيًا بناءً على امتدادات الملفات.</p>
                    <div class="input-row" style="margin-bottom: 10px;">
                        <input type="text" id="newExtensionInput" class="input-field" placeholder=".example (مثال: .txt, .doc)">
                        <input type="text" id="newExtensionCategoryNameInput" class="input-field" placeholder="اسم عرض الفئة (مثال: ملفات نصية)">
                    </div>
                    <button id="addExtensionMappingBtn" class="btn btn-success">
                        <svg viewBox="0 0 24 24"><use xlink:href="#icon-add"></use></svg>
                        إضافة ربط امتداد
                    </button>
                    <div id="extensionMappingsContainer" style="margin-top: 15px;"></div>
                </div>

                <div class="options-group">
                    <h3>فاصل زمني لفتح عناصر متعددة</h3>
                    <p>اضبط التأخير (بالثواني) بين فتح كل عنصر عند استخدام "فتح الكل" أو "فتح الكل في الفئة".</p>
                     <div class="input-row" style="max-width: 300px;">
                        <label for="openIntervalInput" style="white-space: nowrap; align-self: center;">الفاصل الزمني (ثواني):</label>
                        <input type="number" id="openIntervalInput" class="input-field" value="0.3" min="0.05" step="0.05">
                    </div>
                    <button id="saveOpenIntervalBtn" class="btn btn-success" style="margin-top:10px;">
                        <svg viewBox="0 0 24 24"><use xlink:href="#icon-save"></use></svg> حفظ الفاصل
                    </button>
                </div>

                <div class="options-group">
                    <h3>تحديثات التطبيق</h3>
                    <p>تحقق من أحدث إصدار لـ مدير مسارات هيمو.</p>
                    <button id="checkForUpdatesBtn" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-left:8px; margin-right:0;"><path d="M12 2.5c-5.25 0-9.5 4.25-9.5 9.5s4.25 9.5 9.5 9.5 9.5-4.25 9.5-9.5S17.25 2.5 12 2.5zm0 2c4.14 0 7.5 3.36 7.5 7.5s-3.36 7.5-7.5 7.5-7.5-3.36-7.5-7.5S7.86 4.5 12 4.5zm-1 11.5h2v2h-2v-2zm0-8h2v6h-2V8z"/></svg>
                        التحقق من وجود تحديثات
                    </button>
                    <p id="updateStatusMessage" style="font-size: 0.8rem; color: #90a4ae; margin-top: 10px;"></p>
                    <!-- حاوية لأزرار إعادة التشغيل الآن / لاحقًا -->
                    <div id="updateActionButtonsContainer" style="margin-top: 10px;"></div>
                </div>


                <div class="options-group">
                    <h3>إدارة البيانات</h3>
                     <p>إدارة جميع بيانات التطبيق المخزنة.</p>
                    <button id="clearAllDataBtnOptionsPage" class="btn btn-danger"> <svg viewBox="0 0 24 24"><use xlink:href="#icon-clear-all"></use></svg>
                        مسح جميع بيانات التطبيق
                    </button>
                </div>
            </div>
        </div>


        <div id="aboutPage" class="page">
             <div class="page-header-container">
                <div>
                    <h1 class="page-title">حول مدير مسارات هيمو</h1>
                    <p class="page-subtitle">أداتك المثلى لتنظيم ملفات المشاريع</p>
                </div>
            </div>
            <div class="glass-card">
                <h3>مدير مسارات هيمو</h3>
                <p>الإصدار: <span id="appVersionDisplay">جاري التحميل...</span></p>
                <p>تم تطويره لتبسيط إدارة مسارات ملفات مشاريعك، روابط المواقع، والمهام.</p>
                <br>
                <h4>الميزات الرئيسية:</h4>
                <ul>
                    <li>إضافة وتصنيف مسارات الملفات، روابط المجلدات، وعناوين URL للمواقع بسهولة عبر نافذة منبثقة موحدة.</li>
                    <li>فتح الملفات والمجلدات والمواقع مباشرة من التطبيق.</li>
                    <li>إدارة الفئات المخصصة وربط امتدادات الملفات لتنظيم أفضل.</li>
                    <li>قائمة مهام مدمجة مع وظيفة التعديل لتتبع مهامك.</li>
                    <li>حفظ وتحميل إعدادات المشروع بالكامل كملفات `.hpmt`.</li>
                    <li>سجل لملفات المشاريع المستخدمة مؤخرًا.</li>
                    <li>واجهة مستخدم عصرية وجذابة مع نافذة بدون إطار.</li>
                </ul>
            </div>
        </div>
    </main>
    
    <!-- أيقونات SVG -->
    <svg width="0" height="0" style="display:none;">
        <symbol id="icon-folder" viewBox="0 0 24 24"><path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></symbol>
        <symbol id="icon-file" viewBox="0 0 24 24"><path d="M13 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V9l-7-7zm4 18H7V4h5v5h5v11z"/></symbol>
        <symbol id="icon-website" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93s3.05-7.44 7-7.93v15.86zm2-15.86c1.03.13 2 .45 2.87.93L15 8h-3V4.07zm0 5.93H15l.8 2H12V10zm0 4h3l.87 2.07c-.87.48-1.84.8-2.87.93V14zm5.96-2H18v-2h1.96c.03.33.04.66.04 1s-.01.67-.04 1z"/></symbol>
        <symbol id="icon-photoshop" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.5 14.5V7.5h3V10l2.5-2.5L18.5 10l-2.5 2.5L18.5 15l-2.5 2.5-2.5-2.5V16.5h-3zM9 14.5v-5l-2.5 2.5L9 14.5z"/></symbol>
        <symbol id="icon-aftereffects" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15l-4-4h2.5v-3h3v3H16l-4 4zM8.5 9.5L12 6l3.5 3.5h-2v3h-3v-3h-2z"/></symbol>
        <symbol id="icon-premiere" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM9.5 16.5L14.5 12L9.5 7.5v9zM15 16h-2V8h2v8z"/></symbol>
        <symbol id="icon-options" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.39.39 0 00-.55 0l-1.83 1.83 3.75 3.75 1.83-1.83zM3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 000-1.41l-2.34-2.34a.996.996 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></symbol> 
        <symbol id="icon-delete" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        <symbol id="icon-open" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></symbol>
        <symbol id="icon-show-location" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></symbol>
        <symbol id="icon-add" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
        <symbol id="icon-save" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></symbol>
        <symbol id="icon-cancel" viewBox="0 0 24 24"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></symbol>
        <symbol id="icon-chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></symbol> 
        <symbol id="icon-chevron-left" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></symbol>
        <symbol id="icon-empty-folder" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 10H6V8h12v8z"/></symbol>
        <symbol id="icon-empty-history" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></symbol>
        <symbol id="icon-rocket" viewBox="0 0 24 24"><path d="M13.12,2.25a1.5,1.5,0,0,0-2.24,0L3.54,9.59A4.48,4.48,0,0,0,3,12a4.48,4.48,0,0,0,.54,2.41L10.88,21.75a1.5,1.5,0,0,0,2.24,0l7.34-7.34A4.48,4.48,0,0,0,21,12a4.48,4.48,0,0,0-.54-2.41ZM12,14a2,2,0,1,1,2-2A2,2,0,0,1,12,14Z"/></symbol>
        <symbol id="icon-clear-all" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM8 9h8v10H8V9zm7.5-5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        <symbol id="icon-paste" viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0S9.6.84 9.18 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v2h10V4h2v16z"/></symbol>
        <symbol id="icon-arrow-up" viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></symbol>
        <symbol id="icon-arrow-down" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></symbol>
        <symbol id="icon-settings-alt" viewBox="0 0 24 24"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38 2.65c.61-.25 1.17-.59-1.69-.98l2.49 1c.23.08.49 0 .61.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></symbol>
        <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol>
        <symbol id="icon-history" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7v2c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8H12z"/></symbol>
        <symbol id="icon-rename" viewBox="0 0 24 24"><path d="M20.71 4.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83zM3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM5.92 19H5v-.92l9.06-9.06.92.92L5.92 19z"/></symbol> <!-- أيقونة تعديل الاسم -->
    </svg>

    <!-- تم إزالة مودال إضافة العناصر من هنا -->

    <!-- إشعار التوست (سيبقى في مكانه الحالي ليتم التحكم به عبر CSS) -->
    <div id="notificationToast" class="notification-toast"></div>

    <!-- حاوية شريط تقدم التحميل -->
    <div id="downloadProgressContainer" class="download-progress-bar-container">
        <div id="downloadProgressBarInner" class="download-progress-bar-inner">
            <span id="downloadProgressBarText" class="download-progress-bar-text">جاري التحميل...</span>
        </div>
    </div>

    <div id="confirmModalBackdrop" class="modal-backdrop"> <div class="modal-dialog"> <p id="confirmModalMessage"></p> <div class="modal-dialog-actions"> <button id="confirmModalYesBtn" class="btn btn-danger">نعم</button> <button id="confirmModalNoBtn" class="btn btn-primary">لا</button> </div> </div> </div>
    <div id="categoryManagerModal" class="modal-backdrop"> <div class="category-manager-content"> <h2>إدارة الفئات</h2> <div id="categoryListContainer"></div> <div class="add-category-form"> <input type="text" id="newManagedCategoryInput" class="input-field" placeholder="اسم الفئة الجديدة"> <button id="addManagedCategoryBtn" class="btn btn-success"> <svg viewBox="0 0 24 24"><use xlink:href="#icon-add"></use></svg>إضافة فئة </button> </div> <div class="category-manager-actions"> <button id="closeCategoryManagerBtn" class="btn btn-secondary">إغلاق</button> </div> </div> </div>
    <div class="loading-indicator" id="loadingOverlay"> <div class="spinner"></div></div>

    <script>
    // وحدات Electron و Node.js
    let shell = null, pathModule = null, ipcRenderer = null, electronClipboard = null, appVersion = 'N/A'; // إضافة متغير لإصدار التطبيق
    try {
        if (typeof require === 'function' && typeof window !== 'undefined' && window.process && window.process.type === 'renderer') {
            shell = require('electron').shell;
            pathModule = require('path');
            ipcRenderer = require('electron').ipcRenderer;
            electronClipboard = require('electron').clipboard;
            console.log("[Renderer] Electron environment detected.");
        }
    } catch (e) { console.warn("[Renderer] Error loading Electron modules.", e); }

    let projectFiles = [];
    let stagedFilePaths = []; // ستبقى هذه لتخزين المسارات المختارة مؤقتًا قبل الضغط على "إضافة إلى القائمة"
    let appCategories = [];
    let todos = [];
    let customExtensionMappings = [];
    let projectHistory = [];
    let activeFilePath = null;
    let openInterval = 0.3;

    const DOM = {
        sidebar: document.getElementById('sidebar'),
        mainContent: document.getElementById('mainContent'),
        // تم إزالة addItemFab
        // عناصر واجهة إضافة العناصر المدمجة
        integratedSelectFilesButton: document.getElementById('integratedSelectFilesButton'),
        integratedAddFolderLinkButton: document.getElementById('integratedAddFolderLinkButton'),
        integratedImportFromFolderButton: document.getElementById('integratedImportFromFolderButton'),
        integratedPathInput: document.getElementById('integratedPathInput'),
        integratedPastePathButton: document.getElementById('integratedPastePathButton'),
        integratedAddPastedPathButton: document.getElementById('integratedAddPastedPathButton'),
        integratedProjectNameInput: document.getElementById('integratedProjectNameInput'),
        integratedCategorySelectInput: document.getElementById('integratedCategorySelectInput'),
        integratedAddItemsButton: document.getElementById('integratedAddItemsButton'),
        integratedSelectedFilesDisplay: document.getElementById('integratedSelectedFilesDisplay'),

        filesDisplayContainer: document.getElementById('itemsDisplayArea'),
        fileCountDisplay: document.getElementById('fileCount'),
        openAllBtn: document.getElementById('openAllBtn'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        notification: document.getElementById('notificationToast'),
        confirmModal: document.getElementById('confirmModalBackdrop'),
        confirmModalMessage: document.getElementById('confirmModalMessage'),
        confirmModalYesBtn: document.getElementById('confirmModalYesBtn'),
        confirmModalNoBtn: document.getElementById('confirmModalNoBtn'),
        manageCategoriesBtn: document.getElementById('manageCategoriesBtn'),
        categoryManagerModal: document.getElementById('categoryManagerModal'),
        categoryListContainer: document.getElementById('categoryListContainer'),
        newManagedCategoryInput: document.getElementById('newManagedCategoryInput'),
        addManagedCategoryBtn: document.getElementById('addManagedCategoryBtn'),
        closeCategoryManagerBtn: document.getElementById('closeCategoryManagerBtn'),
        todoInput: document.getElementById('todoInput'),
        addTodoBtn: document.getElementById('addTodoBtn'),
        todosContainer: document.getElementById('todosContainer'),
        clearAllDataBtnOptionsPage: document.getElementById('clearAllDataBtnOptionsPage'),
        newExtensionInput: document.getElementById('newExtensionInput'),
        newExtensionCategoryNameInput: document.getElementById('newExtensionCategoryNameInput'),
        addExtensionMappingBtn: document.getElementById('addExtensionMappingBtn'),
        extensionMappingsContainer: document.getElementById('extensionMappingsContainer'),
        saveProjectAsBtn: document.getElementById('saveProjectAsBtn'),
        importProjectBtn: document.getElementById('importProjectBtn'),
        saveActiveProjectBtn: document.getElementById('saveActiveProjectBtn'),
        projectHistoryContainer: document.getElementById('projectHistoryContainer'),
        activeProjectInfo: document.getElementById('activeProjectInfo'),
        openIntervalInput: document.getElementById('openIntervalInput'),
        saveOpenIntervalBtn: document.getElementById('saveOpenIntervalBtn'),
        clearHistoryBtn: document.getElementById('clearHistoryBtn'),
        checkForUpdatesBtn: document.getElementById('checkForUpdatesBtn'),
        updateStatusMessage: document.getElementById('updateStatusMessage'),
        updateActionButtonsContainer: document.getElementById('updateActionButtonsContainer'),
        downloadProgressContainer: document.getElementById('downloadProgressContainer'),
        downloadProgressBarInner: document.getElementById('downloadProgressBarInner'),
        downloadProgressBarText: document.getElementById('downloadProgressBarText'),
        appVersionDisplay: document.getElementById('appVersionDisplay')
    };

    const STORAGE_ITEMS_KEY = 'projectFileManagerData_v1.8_IntegratedUI'; // تحديث مفتاح التخزين
    const STORAGE_CATEGORIES_KEY = 'projectFileManagerCategories_v1.8_IntegratedUI';
    const STORAGE_TODOS_KEY = 'projectFileManagerTodos_v1.8_IntegratedUI';
    const STORAGE_EXTENSION_MAPPINGS_KEY = 'projectFileManagerExtMappings_v1.3_IntegratedUI';
    const STORAGE_PROJECT_HISTORY_KEY = 'projectFileManagerHistory_v1.2_IntegratedUI';
    const STORAGE_OPEN_INTERVAL_KEY = 'projectFileManagerOpenInterval_v1.1';
    const STORAGE_CATEGORY_STATE_KEY = 'projectFileManagerCategoryState_v1.0'; // لتخزين حالة on/off للأقسام
    const DEFAULT_OPEN_INTERVAL = 0.3;
    const MAX_HISTORY_ITEMS = 10;


    const DEFAULT_CATEGORIES_STRUCTURE = [
        { key: 'auto_detect', display: '--- كشف تلقائي للفئة ---', isCustom: false, isDefaultOption: true, order: 0, isEditable: false, isDeletable: false, isEnabledForOpenAll: true },
        { key: 'photoshop', display: 'مشاريع فوتوشوب', isCustom: false, order: 1, isEditable: true, isDeletable: false, isEnabledForOpenAll: true },
        { key: 'aftereffects', display: 'مشاريع أفترإفكتس', isCustom: false, order: 2, isEditable: true, isDeletable: false, isEnabledForOpenAll: true },
        { key: 'premiere', display: 'مشاريع بريمير برو', isCustom: false, order: 3, isEditable: true, isDeletable: false, isEnabledForOpenAll: true },
        { key: 'folder', display: 'روابط المجلدات', isCustom: false, order: 4, isEditable: true, isDeletable: false, isEnabledForOpenAll: true },
        { key: 'website', display: 'روابط المواقع', isCustom: false, order: 5, isEditable: true, isDeletable: false, isEnabledForOpenAll: true },
        { key: 'general', display: 'ملفات عامة', isCustom: false, order: 6, isEditable: true, isDeletable: false, isEnabledForOpenAll: true },
    ];
    const FILE_TYPE_TO_DEFAULT_CAT_KEY = { 'photoshop': 'photoshop', 'aftereffects': 'aftereffects', 'premiere': 'premiere', 'folderLink': 'folder', 'websiteLink': 'website' };
    
    // ... (دوال JavaScript الأخرى تبقى كما هي مبدئيًا، مع تعديلات لاحقًا) ...

    function showAppNotification(message, type = 'success', duration = 3500) {
        const el = DOM.notification;
        if (el) {
            el.textContent = message;
            el.className = `notification-toast ${type} show`;
            // CSS سيتحكم في التموضع في الأسفل والوسط
            if (el.timeoutId) clearTimeout(el.timeoutId);
            el.timeoutId = setTimeout(() => {
                el.classList.remove('show');
            }, duration);
        } else {
            console.warn("Notification element not found for:", message);
        }
    }
    
    function showDownloadProgressBar(show) {
        if (DOM.downloadProgressContainer) {
            DOM.downloadProgressContainer.style.display = show ? 'flex' : 'none'; // 'flex' للتوسيط إذا كان هناك نص
        }
    }

    function updateDownloadProgressBar(percent, speedMBps, transferredMB, totalMB) {
        if (DOM.downloadProgressBarInner && DOM.downloadProgressBarText) {
            DOM.downloadProgressBarInner.style.width = `${percent}%`;
            let text = `جاري التحميل: ${Math.round(percent)}%`;
            if (speedMBps !== null && !isNaN(speedMBps)) {
                 text += ` (${speedMBps.toFixed(2)} ميجابايت/ثانية)`;
            }
            if (transferredMB !== null && totalMB !== null && !isNaN(transferredMB) && !isNaN(totalMB)) {
                text += ` - ${transferredMB.toFixed(1)}MB / ${totalMB.toFixed(1)}MB`;
            }
            DOM.downloadProgressBarText.textContent = text;
        }
    }

    function clearStagedFilesDisplay() { // اسم جديد للدالة
        stagedFilePaths = [];
        if(DOM.integratedSelectedFilesDisplay) DOM.integratedSelectedFilesDisplay.textContent = '';
    }

    function updateStagedPathsDisplay(paths, entryType, prefix) { // اسم جديد للدالة
        if (paths && Array.isArray(paths) && paths.length > 0) {
            stagedFilePaths = paths.map(p => ({ path: p, name: pathModule ? pathModule.basename(p) : p.substring(p.lastIndexOf(/[/\\]/) + 1), entryType }));
            if(DOM.integratedSelectedFilesDisplay) DOM.integratedSelectedFilesDisplay.textContent = `${prefix} ${stagedFilePaths.map(f => f.name).join(', ')}`; 
            if(DOM.integratedPathInput) DOM.integratedPathInput.value = ''; 
        } else if (DOM.integratedPathInput && !DOM.integratedPathInput.value.trim()) {
            clearStagedFilesDisplay();
        }
    }
    
    function populateCategoryDropdown(selectElement = DOM.integratedCategorySelectInput) { // استخدام العنصر المدمج
        if (!selectElement) return;
        selectElement.innerHTML = '';
        const sortedForDropdown = [...appCategories].sort((a,b) => (a.order ?? Infinity) - (b.order ?? Infinity));
        sortedForDropdown.forEach(cat => { const option = document.createElement('option'); option.value = cat.key; option.textContent = cat.display; if (cat.isDefaultOption) option.selected = true; selectElement.appendChild(option); });
    }

    function handleProcessStagedItems() { // اسم جديد للدالة
        if (!stagedFilePaths || stagedFilePaths.length === 0) {
            // تحقق مما إذا كان هناك نص في حقل المسار المباشر
            const pathValue = DOM.integratedPathInput.value.trim();
            if (pathValue) {
                // إذا كان هناك نص، حاول إضافته كمسار مباشر
                if (ipcRenderer) {
                    ipcRenderer.send('process-pasted-path', pathValue); // سيتم التعامل مع الرد في setupIpcListeners
                } else if (pathValue.toLowerCase().startsWith('http://') || pathValue.toLowerCase().startsWith('https://')) {
                    updateStagedPathsDisplay([pathValue], 'websiteLink', 'رابط موقع جاهز: ');
                    // ثم قم بإضافة العنصر مباشرة
                     processSingleItemFromStaged();
                } else {
                    showAppNotification('إضافة المسارات المحلية متاحة فقط في تطبيق سطح المكتب.', 'warning');
                }
                return;
            }
            showAppNotification('الرجاء تحديد أو لصق العناصر أولاً.', 'warning');
            return;
        }
        processSingleItemFromStaged(); // معالجة العناصر الموجودة في stagedFilePaths
    }

    function processSingleItemFromStaged() { // دالة جديدة لمعالجة العناصر المضافة
        const groupName = DOM.integratedProjectNameInput.value.trim();
        let addedCount = 0;
        stagedFilePaths.forEach(itemInfo => {
            const { path, name, entryType = 'file' } = itemInfo;
            if (!path || typeof path !== 'string' || projectFiles.some(pf => pf.location.toLowerCase() === path.toLowerCase())) {
                if (projectFiles.some(pf => pf.location.toLowerCase() === path.toLowerCase())) { showAppNotification(`العنصر "${name}" موجود بالفعل.`, 'warning'); }
                return;
            }
            const itemType = getFileType(path, entryType);
            const catKey = determineItemCategoryKey(itemType, DOM.integratedCategorySelectInput.value);
            projectFiles.push({ id: Date.now() + Math.random(), name: groupName ? `${groupName} - ${name}` : name, actualName: name, location: path, type: itemType, category: catKey, entryType, dateAdded: new Date().toLocaleString('ar-SA', { dateStyle: 'short', timeStyle: 'short' }), isEnabledForOpenAll: true }); // تمت إضافة isEnabledForOpenAll
            addedCount++;
        });

        if (addedCount > 0) {
            saveItemsToStorage();
            renderProjectFilesUI();
            showAppNotification(`✨ تمت إضافة ${addedCount} عنصر (عناصر)!`, 'success');
        }
        DOM.integratedProjectNameInput.value = '';
        clearStagedFilesDisplay();
        DOM.integratedCategorySelectInput.value = 'auto_detect';
        if (addedCount > 0 && DOM.integratedProjectNameInput) DOM.integratedProjectNameInput.focus();
    }


    function renderProjectFilesUI() {
        if(!DOM.fileCountDisplay || !DOM.openAllBtn || !DOM.filesDisplayContainer) {
            console.warn("Path Manager UI elements not found, skipping render.");
            return;
        }
        DOM.fileCountDisplay.textContent = projectFiles.length;
        DOM.openAllBtn.disabled = projectFiles.length === 0;
        DOM.filesDisplayContainer.innerHTML = '';

        if (projectFiles.length === 0) {
            DOM.filesDisplayContainer.innerHTML = `<div class="empty-placeholder"><div class="icon"><svg viewBox="0 0 24 24"><use xlink:href="#icon-empty-folder"></use></svg></div><h3>القائمة فارغة.</h3><p>ابدأ بإضافة ملفات أو مجلدات أو روابط مواقع.</p></div>`;
            return;
        }

        const grouped = projectFiles.reduce((acc, item) => {
            const key = item.category || 'general';
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});

        const sortedKeys = Object.keys(grouped).sort((a, b) => {
            const catA = appCategories.find(c => c.key === a) || { order: Infinity, display: a };
            const catB = appCategories.find(c => c.key === b) || { order: Infinity, display: b };
            return (catA.order ?? Infinity) - (catB.order ?? Infinity) || catA.display.localeCompare(catB.display, 'ar'); // استخدام 'ar' للترتيب العربي
        });

        sortedKeys.forEach(catKey => {
            const items = grouped[catKey];
            const section = document.createElement('div');
            const categoryObject = appCategories.find(c => c.key === catKey) || { display: catKey, isEnabledForOpenAll: true }; // قيمة افتراضية لـ isEnabledForOpenAll
            section.className = `category-section ${categoryObject.isCollapsed ? 'collapsed' : ''}`; // تحقق من حالة الطي
            section.dataset.categoryKey = catKey;

            const header = document.createElement('div');
            header.className = 'category-header';
            const catDisplay = getCategoryDisplay(catKey);
            
            const chevronIcon = document.dir === 'rtl' ? '#icon-chevron-left' : '#icon-chevron-right';

            header.innerHTML = `
                <div class="category-title-container" title="فتح/إغلاق القسم">
                    <span class="category-toggle-icon"><svg viewBox="0 0 24 24"><use xlink:href="${chevronIcon}"></use></svg></span>
                    <h2 class="category-title" data-category-key="${escapeAttr(catKey)}">${escapeHTML(catDisplay)}</h2>
                    <span class="category-item-count">(${items.length})</span>
                </div>
                <div class="category-header-controls">
                    <button class="btn-icon btn-edit-category-name" title="تعديل اسم القسم" data-category-key="${escapeAttr(catKey)}">
                        <svg viewBox="0 0 24 24"><use xlink:href="#icon-rename"></use></svg>
                    </button>
                    <button class="btn-icon btn-delete-category-header" title="حذف القسم" data-category-key="${escapeAttr(catKey)}" ${(!categoryObject.isCustom || !categoryObject.isDeletable) ? 'disabled' : ''}>
                        <svg viewBox="0 0 24 24"><use xlink:href="#icon-delete"></use></svg>
                    </button>
                    <button class="category-on-off-toggle ${categoryObject.isEnabledForOpenAll ? 'on' : 'off'}" 
                            data-category-key="${escapeAttr(catKey)}" 
                            title="${categoryObject.isEnabledForOpenAll ? 'تعطيل الفتح مع الكل' : 'تفعيل الفتح مع الكل'}">
                        ${categoryObject.isEnabledForOpenAll ? 'ON' : 'OFF'}
                    </button>
                    <button class="btn btn-secondary btn-open-all-in-category" data-category-key="${escapeAttr(catKey)}">
                        <svg viewBox="0 0 24 24"><use xlink:href="#icon-folder"></use></svg>فتح الكل في القسم
                    </button>
                </div>`;
            
            header.querySelector('.category-title-container').addEventListener('click', () => {
                section.classList.toggle('collapsed');
                categoryObject.isCollapsed = section.classList.contains('collapsed'); // حفظ حالة الطي
                saveCategoryStates();
            });
            header.querySelector('.btn-open-all-in-category').addEventListener('click', (e) => { e.stopPropagation(); handleOpenAllFilesInCategory(e); });
            header.querySelector('.btn-edit-category-name').addEventListener('click', (e) => { e.stopPropagation(); activateCategoryNameInlineEdit(e.currentTarget.dataset.categoryKey, header); });
            header.querySelector('.btn-delete-category-header').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteManagedCategory(e.currentTarget.dataset.categoryKey); });
            header.querySelector('.category-on-off-toggle').addEventListener('click', (e) => { e.stopPropagation(); toggleCategoryOpenAllState(e.currentTarget.dataset.categoryKey, e.currentTarget); });


            const grid = document.createElement('div');
            grid.className = 'items-grid';
            items.forEach((item, idx) => {
                const cardHTML = createFileCardHTML(item, idx);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML.trim();
                const cardElement = tempDiv.firstChild;
                if (cardElement) {
                    cardElement.classList.add('fade-in-item');
                    grid.appendChild(cardElement);
                }
            });
            section.appendChild(header);
            section.appendChild(grid);
            DOM.filesDisplayContainer.appendChild(section);
        });
        DOM.filesDisplayContainer.querySelectorAll('.path-card-options-btn, .item-card-direct-open').forEach(btn => btn.addEventListener('click', handleItemCardButton));
        loadCategoryStates(); // استعادة حالة الطي بعد العرض
    }

    function activateCategoryNameInlineEdit(categoryKey, headerElement) {
        const titleElement = headerElement.querySelector(`.category-title[data-category-key="${categoryKey}"]`);
        const category = appCategories.find(c => c.key === categoryKey);
        if (!titleElement || !category || (!category.isCustom && !category.isEditable)) return;

        const currentName = category.display;
        const inputField = document.createElement('input');
        inputField.type = 'text';
        inputField.className = 'category-name-input input-field'; // استخدام نفس نمط حقول الإدخال
        inputField.value = currentName;
        inputField.dataset.originalName = currentName;

        titleElement.replaceWith(inputField);
        inputField.focus();
        inputField.select();

        const saveAndCancel = () => {
            const newDisplayName = inputField.value.trim();
            if (newDisplayName && newDisplayName !== currentName) {
                if (appCategories.some(cat => cat.key !== categoryKey && cat.display.toLowerCase() === newDisplayName.toLowerCase())) {
                    showAppNotification(`اسم الفئة "${newDisplayName}" موجود بالفعل.`, 'warning');
                    inputField.value = currentName; // إعادة القيمة الأصلية
                    inputField.replaceWith(titleElement); // إعادة العنوان الأصلي
                    titleElement.textContent = currentName;
                    return;
                }
                category.display = newDisplayName;
                titleElement.textContent = newDisplayName;
            } else {
                titleElement.textContent = currentName; // إعادة الاسم الأصلي إذا لم يتغير أو كان فارغًا
            }
            inputField.replaceWith(titleElement);
            saveCategoriesToStorage();
            populateCategoryDropdown(); // تحديث القائمة المنسدلة في قسم الإضافة المدمج
            if (DOM.categoryManagerModal.classList.contains('show')) { // تحديث قائمة مدير الفئات إذا كانت مفتوحة
                 renderCategoryManagerList();
            }
        };

        inputField.addEventListener('blur', saveAndCancel);
        inputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveAndCancel();
            } else if (e.key === 'Escape') {
                inputField.value = currentName; // تجاهل التغييرات
                saveAndCancel(); // سيعيد العنصر الأصلي
            }
        });
    }
    
    function saveCategoryStates() {
        const states = {};
        appCategories.forEach(cat => {
            states[cat.key] = { isCollapsed: !!cat.isCollapsed, isEnabledForOpenAll: !!cat.isEnabledForOpenAll };
        });
        try {
            localStorage.setItem(STORAGE_CATEGORY_STATE_KEY, JSON.stringify(states));
        } catch (e) {
            console.error("Error saving category states:", e);
        }
    }

    function loadCategoryStates() {
        try {
            const storedStates = localStorage.getItem(STORAGE_CATEGORY_STATE_KEY);
            if (storedStates) {
                const states = JSON.parse(storedStates);
                appCategories.forEach(cat => {
                    if (states[cat.key]) {
                        cat.isCollapsed = states[cat.key].isCollapsed;
                        cat.isEnabledForOpenAll = states[cat.key].isEnabledForOpenAll !== undefined ? states[cat.key].isEnabledForOpenAll : true;
                    } else {
                        cat.isEnabledForOpenAll = true; // القيمة الافتراضية إذا لم تكن الحالة مخزنة
                    }
                });
                 // إعادة عرض الواجهة لتعكس الحالات المحملة (خاصة الطي)
                renderProjectFilesUI();
            } else {
                 // إذا لم تكن هناك حالات مخزنة، تأكد من أن جميع الفئات لديها isEnabledForOpenAll = true
                appCategories.forEach(cat => cat.isEnabledForOpenAll = true);
            }
        } catch (e) {
            console.error("Error loading category states:", e);
            appCategories.forEach(cat => cat.isEnabledForOpenAll = true); // تعيين افتراضي عند الخطأ
        }
    }
    
    function toggleCategoryOpenAllState(categoryKey, buttonElement) {
        const category = appCategories.find(cat => cat.key === categoryKey);
        if (category) {
            category.isEnabledForOpenAll = !category.isEnabledForOpenAll;
            buttonElement.textContent = category.isEnabledForOpenAll ? 'ON' : 'OFF';
            buttonElement.classList.toggle('on', category.isEnabledForOpenAll);
            buttonElement.classList.toggle('off', !category.isEnabledForOpenAll);
            buttonElement.title = category.isEnabledForOpenAll ? 'تعطيل الفتح مع الكل' : 'تفعيل الفتح مع الكل';
            saveCategoryStates(); // حفظ الحالة الجديدة
            showAppNotification(`الفتح مع الكل لفئة "${category.display}" الآن ${category.isEnabledForOpenAll ? 'مُفعّل' : 'مُعطّل'}.`, 'info');
        }
    }

    function handleOpenAllClick() {
        const itemsToOpenOverall = projectFiles.filter(item => {
            const category = appCategories.find(c => c.key === item.category);
            return category && category.isEnabledForOpenAll; // تحقق من أن الفئة مفعلة للفتح
        });

        if (itemsToOpenOverall.length === 0) {
            showAppNotification("لا توجد عناصر لفتحها (إما القائمة فارغة أو جميع الفئات معطلة للفتح مع الكل).", "info");
            return;
        }
        const delayBetweenTypes = openInterval * 1000 * 2;
        openMultiple(itemsToOpenOverall.filter(i => i.entryType === 'file'), 'file', 'جميع الملفات (المفعلة)');
        let nextDelay = itemsToOpenOverall.filter(i => i.entryType === 'file').length * (openInterval * 1000) + delayBetweenTypes;
        setTimeout(() => { openMultiple(itemsToOpenOverall.filter(i => i.entryType === 'folderLink'), 'folderLink', 'جميع روابط المجلدات (المفعلة)'); }, nextDelay);
        nextDelay += itemsToOpenOverall.filter(i => i.entryType === 'folderLink').length * (openInterval * 1000) + delayBetweenTypes;
        setTimeout(() => { openMultiple(itemsToOpenOverall.filter(i => i.entryType === 'websiteLink'), 'websiteLink', 'جميع روابط المواقع (المفعلة)'); }, nextDelay);
    }

    function handleOpenAllFilesInCategory(event) {
        const key = event.currentTarget.dataset.categoryKey;
        const categoryObject = appCategories.find(c => c.key === key);
        const categoryDisplay = getCategoryDisplay(key);

        if (!categoryObject || !categoryObject.isEnabledForOpenAll) {
            showAppNotification(`الفتح مع الكل معطل لهذه الفئة "${categoryDisplay}".`, "info");
            return;
        }

        const itemsInCategory = projectFiles.filter(i => i.category === key);
        if (itemsInCategory.length === 0) {
            showAppNotification(`لا توجد عناصر لفتحها في فئة "${categoryDisplay}".`, "info");
            return;
        }
        const delayBetweenTypes = openInterval * 1000 * 2;
        openMultiple(itemsInCategory.filter(i => i.entryType === 'file'), 'file', categoryDisplay);
        let nextDelay = itemsInCategory.filter(i => i.entryType === 'file').length * (openInterval * 1000) + delayBetweenTypes;
        setTimeout(() => { openMultiple(itemsInCategory.filter(i => i.entryType === 'folderLink'), 'folderLink', categoryDisplay); }, nextDelay);
        nextDelay += itemsInCategory.filter(i => i.entryType === 'folderLink').length * (openInterval * 1000) + delayBetweenTypes;
        setTimeout(() => { openMultiple(itemsInCategory.filter(i => i.entryType === 'websiteLink'), 'websiteLink', categoryDisplay); }, nextDelay);
    }


    // ... (بقية دوال JavaScript مع تعديلات طفيفة للإشارة إلى عناصر DOM المدمجة) ...

    function setupIpcListeners() {
        if (!ipcRenderer) {
            console.warn("[Renderer] ipcRenderer not available. Desktop features will be disabled.");
            [DOM.integratedSelectFilesButton, DOM.integratedAddFolderLinkButton, DOM.integratedImportFromFolderButton, 
             DOM.integratedPastePathButton, DOM.integratedAddPastedPathButton, DOM.saveProjectAsBtn, 
             DOM.importProjectBtn, DOM.saveActiveProjectBtn, DOM.checkForUpdatesBtn].forEach(btn => { 
                if(btn) { 
                    btn.disabled = true; 
                    btn.title = (btn.title || btn.textContent || btn.id) + ' (ميزة تطبيق سطح المكتب فقط)'; 
                    btn.style.opacity = "0.5"; 
                    btn.style.cursor = "not-allowed"; 
                } 
            });
            if (DOM.appVersionDisplay) DOM.appVersionDisplay.textContent = "غير متاح (وضع المتصفح)";
            return;
        }
        ipcRenderer.on('selected-files-for-files', (event, paths) => updateStagedPathsDisplay(paths, 'file', 'ملفات جاهزة: '));
        ipcRenderer.on('selected-folder-for-link', (event, paths) => updateStagedPathsDisplay(paths, 'folderLink', 'روابط مجلدات جاهزة: '));
        ipcRenderer.on('selected-folder-for-import', (event, contents) => { 
            if (contents && Array.isArray(contents) && contents.length > 0) { 
                stagedFilePaths = contents.map(item => ({ ...item, entryType: 'file' })); 
                let baseName = "المجلد المحدد"; 
                if (pathModule && contents[0].path) { 
                    const parentDir = pathModule.dirname(contents[0].path); 
                    baseName = pathModule.basename(parentDir); 
                    if (!baseName && parentDir) baseName = parentDir; 
                } 
                if(DOM.integratedSelectedFilesDisplay) DOM.integratedSelectedFilesDisplay.textContent = `ملفات للاستيراد من "${baseName}" (${stagedFilePaths.length})`; 
                if(DOM.integratedPathInput) DOM.integratedPathInput.value = ''; 
            } else if (DOM.integratedPathInput && !DOM.integratedPathInput.value.trim()) {
                clearStagedFilesDisplay();
            }
        });
        ipcRenderer.on('pasted-path-processed', (event, { items, originalPath }) => { 
            if (items && Array.isArray(items) && items.length > 0) {
                 if (items[0].entryType === 'websiteLink') { 
                    updateStagedPathsDisplay(items.map(i => i.path), 'websiteLink', 'رابط موقع جاهز: '); 
                 } else { 
                    stagedFilePaths = items; 
                    if(DOM.integratedSelectedFilesDisplay) DOM.integratedSelectedFilesDisplay.textContent = `تمت معالجة المسار. جاهز للإضافة: ${items.map(f => f.name).join(', ')}`;
                 }
                 // بعد معالجة المسار الملصق بنجاح، قم بإضافته مباشرة
                 processSingleItemFromStaged();
            } else { 
                clearStagedFilesDisplay(); 
                const name = (pathModule && originalPath) ? pathModule.basename(originalPath) : "المسار الملصق"; 
                showAppNotification(`المسار "${name}" غير صالح أو فارغ أو لا يمكن الوصول إليه.`, 'error'); 
            } 
        });
        ipcRenderer.on('pasted-path-error', (event, { message, originalPath }) => { 
            const name = (pathModule && originalPath) ? pathModule.basename(originalPath) : "المسار الملصق"; 
            showAppNotification(`خطأ في معالجة "${name}": ${message}`, 'error'); 
            clearStagedFilesDisplay(); 
        });
        
        ipcRenderer.on('update-status-message', (event, message) => {
            if (DOM.updateStatusMessage) {
                DOM.updateStatusMessage.textContent = message;
            }
            if (!message.toLowerCase().includes('downloading update:') && 
                !message.toLowerCase().includes('update downloaded') &&
                !message.toLowerCase().includes('update available')) { // لا تظهر توست لـ "update available" إذا كان هناك شريط تقدم
                showAppNotification(message, 'info');
            }
             if (message.toLowerCase().includes('update not available') || message.toLowerCase().includes('error checking for updates')) {
                showDownloadProgressBar(false); // إخفاء شريط التقدم عند عدم توفر تحديث أو حدوث خطأ
            }
        });

        ipcRenderer.on('download-progress-info', (event, progressObj) => {
            showDownloadProgressBar(true);
            const speedBytesPerSec = progressObj.bytesPerSecond || 0;
            const speedMBps = speedBytesPerSec / (1024 * 1024);
            const transferredMB = progressObj.transferred / (1024 * 1024);
            const totalMB = progressObj.total / (1024 * 1024);
            updateDownloadProgressBar(progressObj.percent, speedMBps, transferredMB, totalMB);
            if (DOM.updateStatusMessage) {
                 DOM.updateStatusMessage.textContent = `جاري تنزيل التحديث: ${Math.round(progressObj.percent)}% (${speedMBps.toFixed(2)} ميجابايت/ثانية)`;
            }
        });

        ipcRenderer.on('update-downloaded-and-ready', (event, info) => {
            showDownloadProgressBar(false);
            if (DOM.updateStatusMessage) {
                DOM.updateStatusMessage.textContent = `التحديث الإصدار ${info.version} جاهز للتثبيت!`;
            }
            if (DOM.updateActionButtonsContainer) {
                DOM.updateActionButtonsContainer.innerHTML = ''; 

                const restartBtn = document.createElement('button');
                restartBtn.textContent = 'إعادة التشغيل الآن';
                restartBtn.className = 'btn btn-success'; 
                restartBtn.style.marginLeft = '10px'; // تعديل لـ RTL
                restartBtn.onclick = () => {
                    if (ipcRenderer) {
                        ipcRenderer.send('restart-app-and-install');
                    }
                };

                const laterBtn = document.createElement('button');
                laterBtn.textContent = 'لاحقًا';
                laterBtn.className = 'btn btn-secondary';
                laterBtn.onclick = () => {
                    if (DOM.updateActionButtonsContainer) {
                        DOM.updateActionButtonsContainer.innerHTML = ''; 
                    }
                    if (DOM.updateStatusMessage) {
                         DOM.updateStatusMessage.textContent = `تم تنزيل التحديث الإصدار ${info.version}. يمكنك إعادة التشغيل لاحقًا.`;
                    }
                     showAppNotification(`سيتم تثبيت التحديث الإصدار ${info.version} عند إعادة التشغيل التالية.`, 'info', 5000);
                };

                DOM.updateActionButtonsContainer.appendChild(laterBtn); // لاحقًا أولاً في RTL
                DOM.updateActionButtonsContainer.appendChild(restartBtn);
            }
            showAppNotification(`التحديث الإصدار ${info.version} جاهز! انقر فوق 'إعادة التشغيل الآن' للتثبيت.`, 'success', 7000);
        });
        
        ipcRenderer.on('app-version-is', (event, version) => {
            appVersion = version || 'غير متوفر';
            if (DOM.appVersionDisplay) {
                DOM.appVersionDisplay.textContent = appVersion;
            }
            // تحديث النص في صفحة "حول" الذي قد يكون تم عرضه قبل وصول الإصدار
            const aboutPageVersionElement = document.querySelector('#aboutPage .glass-card p:nth-child(2)'); // يفترض أنه ثاني فقرة
            if (aboutPageVersionElement && aboutPageVersionElement.textContent.includes('الإصدار:')) {
                aboutPageVersionElement.innerHTML = `الإصدار: <span id="appVersionDisplay">${appVersion}</span>`;
                // إعادة إسناد DOM.appVersionDisplay إذا تم إنشاؤه ديناميكيًا
                DOM.appVersionDisplay = document.getElementById('appVersionDisplay');
            }
        });
    }
    
    // --- معالجات الأحداث لواجهة إضافة العناصر المدمجة ---
    if(DOM.integratedSelectFilesButton) DOM.integratedSelectFilesButton.addEventListener('click', () => { if (ipcRenderer) ipcRenderer.send('open-file-dialog-for-files'); else showAppNotification('هذه الميزة متاحة فقط في تطبيق سطح المكتب.', 'warning'); });
    if(DOM.integratedAddFolderLinkButton) DOM.integratedAddFolderLinkButton.addEventListener('click', () => { if (ipcRenderer) ipcRenderer.send('open-folder-dialog-for-link'); else showAppNotification('هذه الميزة متاحة فقط في تطبيق سطح المكتب.', 'warning'); });
    if(DOM.integratedImportFromFolderButton) DOM.integratedImportFromFolderButton.addEventListener('click', () => { if (ipcRenderer) ipcRenderer.send('open-folder-dialog-for-import'); else showAppNotification('هذه الميزة متاحة فقط في تطبيق سطح المكتب.', 'warning'); });
    if(DOM.integratedPastePathButton) DOM.integratedPastePathButton.addEventListener('click', async () => {
        let clipboardText = '';
        try { 
            if (electronClipboard) { 
                clipboardText = electronClipboard.readText(); 
            } else if (navigator.clipboard && navigator.clipboard.readText) { 
                clipboardText = await navigator.clipboard.readText(); 
            } else { 
                showAppNotification('واجهة برمجة تطبيقات الحافظة غير متاحة.', 'warning'); return; 
            } 
            if(DOM.integratedPathInput) DOM.integratedPathInput.value = clipboardText; 
            showAppNotification(clipboardText ? 'تم لصق المسار.' : 'الحافظة فارغة.', clipboardText ? 'success' : 'warning');
        } catch (err) { 
            console.error('[Renderer] Failed to read clipboard: ', err); 
            showAppNotification('فشل اللصق من الحافظة. تأكد من الإذن إذا طُلب منك ذلك.', 'error'); 
        }
    });
    if(DOM.integratedAddPastedPathButton) DOM.integratedAddPastedPathButton.addEventListener('click', () => {
        const pathValue = DOM.integratedPathInput.value.trim(); 
        if (!pathValue) { showAppNotification('الرجاء إدخال أو لصق مسار أولاً.', 'warning'); return; }
        
        stagedFilePaths = []; // مسح المسارات القديمة قبل معالجة مسار جديد ملصق
        if(DOM.integratedSelectedFilesDisplay) DOM.integratedSelectedFilesDisplay.textContent = '';

        if (pathValue.toLowerCase().startsWith('http://') || pathValue.toLowerCase().startsWith('https://')) { 
            updateStagedPathsDisplay([pathValue], 'websiteLink', 'رابط موقع جاهز: '); 
            processSingleItemFromStaged(); // إضافة الرابط مباشرة
        } else if (ipcRenderer) { 
            if(DOM.integratedSelectedFilesDisplay) DOM.integratedSelectedFilesDisplay.textContent = `جاري المعالجة: ${pathValue.substring(pathValue.lastIndexOf(/[/\\]/) + 1)}`; 
            ipcRenderer.send('process-pasted-path', pathValue); // سيتم التعامل مع الرد في setupIpcListeners وإضافة العنصر من هناك
        } else { 
            showAppNotification('إضافة المسارات المحلية متاحة فقط في تطبيق سطح المكتب.', 'warning'); 
        }
    });
    if(DOM.integratedAddItemsButton) DOM.integratedAddItemsButton.addEventListener('click', handleProcessStagedItems);
    
    // إضافة وظيفة Enter
    if(DOM.integratedPathInput) DOM.integratedPathInput.addEventListener('keydown', e => { 
        if (e.key === 'Enter') {
            e.preventDefault(); // منع السلوك الافتراضي لـ Enter في حقول الإدخال
            DOM.integratedAddPastedPathButton.click(); // محاكاة النقر على زر "إضافة مسار"
        }
    });
    if(DOM.integratedProjectNameInput) DOM.integratedProjectNameInput.addEventListener('keydown', e => { 
        if (e.key === 'Enter') {
            e.preventDefault();
            if (stagedFilePaths.length > 0 || DOM.integratedPathInput.value.trim()) { // تحقق إذا كان هناك شيء للإضافة
                 handleProcessStagedItems();
            } else {
                showAppNotification('لا يوجد شيء للإضافة. الرجاء تحديد ملفات أو لصق مسار أولاً.', 'warning');
            }
        }
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        document.documentElement.dir = 'rtl'; document.documentElement.lang = 'ar'; // تعيين اتجاه ولغة الصفحة
        setupIpcListeners(); 
        loadData(); // تحميل البيانات أولاً
        loadCategoryStates(); // ثم تحميل حالات الفئات التي قد تعتمد على appCategories
        showPage('pathsPage'); 
        if (window.innerWidth > 768) { if(DOM.sidebar) DOM.sidebar.classList.remove('collapsed'); if(DOM.mainContent) DOM.mainContent.classList.remove('expanded'); } 
        else { if(DOM.sidebar) DOM.sidebar.classList.add('collapsed'); if(DOM.mainContent) DOM.mainContent.classList.add('expanded'); }
        
        if(DOM.openAllBtn) DOM.openAllBtn.addEventListener('click', handleOpenAllClick);
        
        if(DOM.manageCategoriesBtn) DOM.manageCategoriesBtn.addEventListener('click', openCategoryManagerModal);
        if(DOM.closeCategoryManagerBtn) DOM.closeCategoryManagerBtn.addEventListener('click', closeCategoryManagerModal);
        if(DOM.addManagedCategoryBtn) DOM.addManagedCategoryBtn.addEventListener('click', handleAddManagedCategory);
        if(DOM.addTodoBtn) DOM.addTodoBtn.addEventListener('click', addTodo);
        if(DOM.todoInput) DOM.todoInput.addEventListener('keydown', e => { if (e.key === 'Enter') addTodo(); });
        if(DOM.clearAllDataBtnOptionsPage) DOM.clearAllDataBtnOptionsPage.addEventListener('click', clearAllData);
        if(DOM.addExtensionMappingBtn) DOM.addExtensionMappingBtn.addEventListener('click', handleAddCustomExtensionMapping);
        if(DOM.saveProjectAsBtn) DOM.saveProjectAsBtn.addEventListener('click', handleSaveProjectAs);
        if(DOM.importProjectBtn) DOM.importProjectBtn.addEventListener('click', handleImportProject);
        if(DOM.saveActiveProjectBtn) DOM.saveActiveProjectBtn.addEventListener('click', () => handleSaveActiveProject(true));
        if(DOM.saveOpenIntervalBtn) DOM.saveOpenIntervalBtn.addEventListener('click', saveOpenInterval);
        if(DOM.clearHistoryBtn) DOM.clearHistoryBtn.addEventListener('click', handleClearHistory);
        if(DOM.checkForUpdatesBtn) DOM.checkForUpdatesBtn.addEventListener('click', () => {
            if (ipcRenderer) {
                ipcRenderer.send('check-for-updates');
                if(DOM.updateStatusMessage) DOM.updateStatusMessage.textContent = 'جاري التحقق من وجود تحديثات...';
                if(DOM.updateActionButtonsContainer) DOM.updateActionButtonsContainer.innerHTML = ''; 
                showDownloadProgressBar(false); 
            } else {
                showAppNotification('التحقق من التحديثات متاح فقط في تطبيق سطح المكتب.', 'warning');
            }
        });

        if(DOM.filesDisplayContainer) DOM.filesDisplayContainer.addEventListener('click', e => {
            const button = e.target.closest('.item-actions-menu button[data-action], .item-card-direct-open[data-action], .category-header-controls .btn-icon, .category-header-controls .category-on-off-toggle');
            if (button) {
                let itemIdToParse = button.dataset.itemId;
                let categoryKeyForAction = button.dataset.categoryKey;

                if (!itemIdToParse && button.dataset.id) { 
                    itemIdToParse = button.dataset.id;
                }
                if (!itemIdToParse && !categoryKeyForAction) { 
                    const optionsBtn = button.closest('.item-card')?.querySelector('.path-card-options-btn');
                    if (optionsBtn) {
                        itemIdToParse = optionsBtn.dataset.itemId;
                    }
                }

                const action = button.dataset.action || (button.classList.contains('btn-edit-category-name') ? 'edit-category-name' : null) || (button.classList.contains('btn-delete-category-header') ? 'delete-category-header' : null) || (button.classList.contains('category-on-off-toggle') ? 'toggle-category-on-off' : null) ;

                if (itemIdToParse) {
                    const id = parseFloat(itemIdToParse);
                    const item = projectFiles.find(pf => pf.id === id); 
                    if (!item) { console.warn(`Item with id ${id} not found`); showAppNotification('خطأ: العنصر غير موجود.', 'error'); return; }
                    
                    if (action === 'options') { handleOptionsMenu(e); } 
                    else { 
                        const menu = button.closest('.item-actions-menu'); 
                        if(menu) menu.classList.remove('show'); 
                        else { const optionsMenu = document.getElementById(`options-menu-${id}`); if (optionsMenu) optionsMenu.classList.remove('show'); }
                        if (action === 'open') openItem(item.location, item.entryType, item.type);
                        else if (action === 'show-location') showItemInFolder(item.location, item.entryType);
                        else if (action === 'delete') deleteItemEntry(item.id);
                    }
                } else if (categoryKeyForAction && action) {
                     // لا يوجد إجراء محدد هنا، تم التعامل معه مباشرة في renderProjectFilesUI
                }
            }
        });
        if(DOM.newManagedCategoryInput) DOM.newManagedCategoryInput.addEventListener('keydown', e => { if (e.key === 'Enter' && DOM.addManagedCategoryBtn) DOM.addManagedCategoryBtn.click(); }); 
    });
    window.addEventListener('error', e => { console.error('[Renderer] Unhandled Error:', e); showAppNotification('حدث خطأ غير متوقع!', 'error'); });
    window.addEventListener('unhandledrejection', event => { console.error('[Renderer] Unhandled Rejection:', event.reason); showAppNotification('حدث خطأ غير متوقع غير متزامن!', 'error'); });
    </script>
</body>
</html>
